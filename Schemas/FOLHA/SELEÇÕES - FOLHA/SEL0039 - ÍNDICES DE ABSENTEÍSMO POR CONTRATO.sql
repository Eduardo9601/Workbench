/* ====================== PARÂMETROS E JANELA GLOBAL ====================== */
WITH
PARAMS AS (
  SELECT /*+ MATERIALIZE */
    TRUNC(:DATA_INICIO, 'MM') AS DATA_INICIO,
    TRUNC(:DATA_FIM,     'MM') AS DATA_FIM,
    ADD_MONTHS(TRUNC(:DATA_INICIO, 'MM'), LEVEL-1)           AS DATA_MES,
    LAST_DAY(ADD_MONTHS(TRUNC(:DATA_INICIO, 'MM'), LEVEL-1)) AS DATA_MES_FIM
  FROM DUAL
  CONNECT BY LEVEL <= MONTHS_BETWEEN(TRUNC(:DATA_FIM,'MM'), TRUNC(:DATA_INICIO,'MM')) + 1
),
RANGE AS (
  SELECT /*+ MATERIALIZE */ MIN(DATA_INICIO) AS INI, ADD_MONTHS(MAX(DATA_FIM), 1) AS FIM_EXCL FROM PARAMS
),
REF AS (
  SELECT /*+ MATERIALIZE */ MAX(DATA_MES_FIM) AS DATA_REF FROM PARAMS
),

/* ====================== ORGANOGRAMA ATUAL (válido em :DATA_FIM) ====================== */
ORG_ATUAL AS (
  SELECT *
  FROM (
    SELECT
      O.COD_CONTRATO,
      O.COD_ORGANOGRAMA           AS COD_ORGANOGRAMA_ATUAL,
      O.COD_UNIDADE               AS COD_UNIDADE_ATUAL,
      O.DES_UNIDADE               AS DES_UNIDADE_ATUAL,
      O.COD_REDE                  AS COD_REDE_ATUAL,
      O.DES_REDE                  AS DES_REDE_ATUAL,
      O.COD_TIPO                  AS COD_TIPO_ATUAL,
      O.DES_TIPO                  AS DES_TIPO_ATUAL,
      ROW_NUMBER() OVER (
        PARTITION BY O.COD_CONTRATO
        ORDER BY NVL(O.DATA_FIM_ORG, DATE '2999-12-31') DESC, O.DATA_INI_ORG DESC
      ) AS RN
    FROM VH_EST_ORG_CONTRATO_AVT O
    CROSS JOIN REF R
    WHERE R.DATA_REF BETWEEN O.DATA_INI_ORG AND NVL(O.DATA_FIM_ORG, DATE '2999-12-31')
      AND O.COD_EMP = 8
      AND O.EDICAO_ORG_4 IS NOT NULL
  )
  WHERE RN = 1
),

/* ====================== SNAPSHOT CONTRATO x MÊS (usa histórico mensal) ====================== */
DIM AS (
  SELECT /*+ MATERIALIZE */
    CT.STATUS,
    CT.COD_CONTRATO,
    CT.DES_PESSOA,
    CT.DATA_NASCIMENTO,
    CT.DATA_ADMISSAO,
    CT.DATA_DEMISSAO,
    FN.COD_FUNCAO,
    FN.DES_FUNCAO,
    FN.DATA_INI_CLH,
    FN.DATA_FIM_CLH,
    CAST(HR.HR_BASE_MES AS NUMBER) AS HR_BASE_MES,
    HR.DATA_INI_HR,
    HR.DATA_FIM_HR,
    CT.IND_DEFICIENCIA,
    CT.SEXO,
    ORG.COD_EMP,
    ORG.EDICAO_EMP,
    ORG.DES_EMP,
    ORG.COD_ORGANOGRAMA,                  -- histórico (não será exibido)
    ORG.COD_UNIDADE,
    ORG.DES_UNIDADE,
    ORG.DATA_INI_ORG,
    ORG.DATA_FIM_ORG,
    ORG.COD_REDE,
    ORG.DES_REDE,
    ORG.COD_TIPO,
    ORG.DES_TIPO,
    P.DATA_MES,
    P.DATA_MES_FIM,
    TO_CHAR(P.DATA_MES,'MM/YYYY') AS MES_ANO,
    TO_CHAR(P.DATA_MES,'fmMonth YYYY','NLS_DATE_LANGUAGE=PORTUGUESE') AS MES_ANO_EXTENSO,
    P.DATA_INICIO,
    P.DATA_FIM,

    /* campos do organograma ATUAL (para exibir/filtrar) */
    OA.COD_ORGANOGRAMA_ATUAL,
    OA.COD_UNIDADE_ATUAL,
    OA.DES_UNIDADE_ATUAL,
    OA.COD_REDE_ATUAL,
    OA.DES_REDE_ATUAL,
    OA.COD_TIPO_ATUAL,
    OA.DES_TIPO_ATUAL

  FROM V_DADOS_CONTRATO_AVT    CT
  JOIN VH_EST_ORG_CONTRATO_AVT ORG ON ORG.COD_CONTRATO = CT.COD_CONTRATO
  JOIN VH_HIST_HORAS_COLAB_AVT HR  ON HR.COD_CONTRATO  = CT.COD_CONTRATO
  JOIN VH_CARGO_CONTRATO_AVT   FN  ON FN.COD_CONTRATO  = CT.COD_CONTRATO
  JOIN PARAMS P ON 1=1
  JOIN ORG_ATUAL OA ON OA.COD_CONTRATO = CT.COD_CONTRATO   -- filtra por organograma ATUAL
  WHERE ORG.COD_EMP = 8
    AND CT.STATUS = 0
    AND HR.IND_BATE_PONTO = 'S'
    AND FN.DES_FUNCAO NOT LIKE '%APRENDIZ%'
    AND FN.DES_FUNCAO NOT LIKE '%ESTAGIARIO%'
    AND ORG.EDICAO_ORG_4 IS NOT NULL
    /* contrato vigente em algum dia do mês */
    AND CT.DATA_ADMISSAO <= P.DATA_MES_FIM
    AND NVL(CT.DATA_DEMISSAO, DATE '2999-12-31') >= P.DATA_MES
    /* vigências no mês (histórico correto) */
    AND P.DATA_MES BETWEEN ORG.DATA_INI_ORG AND NVL(ORG.DATA_FIM_ORG, DATE '2999-12-31')
    AND P.DATA_MES BETWEEN FN.DATA_INI_CLH  AND NVL(FN.DATA_FIM_CLH , DATE '2999-12-31')
    AND P.DATA_MES BETWEEN HR.DATA_INI_HR   AND NVL(HR.DATA_FIM_HR  , DATE '2999-12-31')
    /* filtros aplicados no organograma ATUAL */
    AND (TO_NUMBER(:TIPO)     = 0 OR OA.COD_TIPO_ATUAL    = TO_NUMBER(:TIPO))
    AND (TO_NUMBER(:FILIAL)   = 0 OR OA.COD_UNIDADE_ATUAL = TO_NUMBER(:FILIAL))
    AND (TO_CHAR(:REDE)       = '0' OR TO_CHAR(OA.COD_REDE_ATUAL) = TO_CHAR(:REDE))
    AND (TO_NUMBER(:CONTRATO) = 0 OR CT.COD_CONTRATO = TO_NUMBER(:CONTRATO))
),

/* ====================== HORAS (pré-agg) ====================== */
HM_AGG AS (
  SELECT /*+ MATERIALIZE */
    HM.COD_CONTRATO,
    TRUNC(HM.DATA_OCORRENCIA, 'MM') AS DATA_MES,
    SUM(CASE WHEN HM.COD_OCORRENCIA = 2 THEN TO_NUMBER(HM.NUM_HORAS) ELSE 0 END) AS TOT_HORAS_TRAB
  FROM RHAF1123 HM
  CROSS JOIN RANGE R
  WHERE HM.DATA_OCORRENCIA >= R.INI
    AND HM.DATA_OCORRENCIA <  R.FIM_EXCL
  GROUP BY HM.COD_CONTRATO, TRUNC(HM.DATA_OCORRENCIA, 'MM')
),
H AS (
  SELECT D.COD_CONTRATO, D.DATA_MES, HA.TOT_HORAS_TRAB
  FROM DIM D
  JOIN HM_AGG HA
    ON HA.COD_CONTRATO = D.COD_CONTRATO
   AND HA.DATA_MES     = D.DATA_MES
  WHERE EXISTS (
          SELECT 1
          FROM RHAF1119 TU
          WHERE TU.COD_CONTRATO = D.COD_CONTRATO
            AND TU.DATA_INICIO <= D.DATA_MES_FIM
            AND NVL(TU.DATA_FIM, DATE '2999-12-31') >= D.DATA_MES
            AND TO_NUMBER(TU.COD_TURNO) NOT IN (2,85)
        )
),

/* ====================== FALTAS/ATESTADOS (pré-agg) ====================== */
A1_AGG AS (
  SELECT /*+ MATERIALIZE */
    C.COD_CONTRATO,
    TRUNC(E.DATA_REFERENCIA, 'MM') AS DATA_MES,
    SUM(CASE WHEN C.COD_VD = 632 THEN TO_NUMBER(C.QTDE_VD) ELSE 0 END)        AS TOT_FALTAS,
    SUM(CASE WHEN C.COD_VD = 897 THEN TO_NUMBER(C.QTDE_VD) ELSE 0 END)        AS TOT_ATESTADOS,
    SUM(CASE WHEN C.COD_VD IN (632,897) THEN TO_NUMBER(C.QTDE_VD) ELSE 0 END) AS TOT_FALTAS_ATESTADOS
  FROM RHFP1006 C
  JOIN RHFP1003 E ON E.COD_MESTRE_EVENTO = C.COD_MESTRE_EVENTO
  CROSS JOIN RANGE R
  WHERE E.DATA_REFERENCIA >= R.INI
    AND E.DATA_REFERENCIA <  R.FIM_EXCL
    AND E.COD_ORGANOGRAMA = 8
  GROUP BY C.COD_CONTRATO, TRUNC(E.DATA_REFERENCIA, 'MM')
),

/* ====================== FÉRIAS (AF=7) por mês para zerar eventos ====================== */
AF7_FLAG AS (
  SELECT /*+ MATERIALIZE */
    D.COD_CONTRATO, D.DATA_MES, 1 AS TEM_FERIAS
  FROM DIM D
  JOIN RHFP0306 AF7
    ON AF7.COD_CONTRATO = D.COD_CONTRATO
   AND AF7.COD_CAUSA_AFAST = 7
   AND AF7.DATA_INICIO <= D.DATA_MES_FIM
   AND NVL(AF7.DATA_FIM, DATE '2999-12-31') >= D.DATA_MES
  GROUP BY D.COD_CONTRATO, D.DATA_MES
),

/* ====================== FALTAS/ATESTADOS ajustados (zera quando AF=7) ====================== */
A1 AS (
  SELECT
    D.COD_CONTRATO,
    D.DATA_MES,
    CASE WHEN F.TEM_FERIAS = 1 THEN 0 ELSE NVL(A.TOT_FALTAS, 0) END           AS TOT_FALTAS,
    CASE WHEN F.TEM_FERIAS = 1 THEN 0 ELSE NVL(A.TOT_ATESTADOS, 0) END        AS TOT_ATESTADOS,
    CASE WHEN F.TEM_FERIAS = 1 THEN 0 ELSE NVL(A.TOT_FALTAS_ATESTADOS, 0) END AS TOT_FALTAS_ATESTADOS
  FROM DIM D
  LEFT JOIN A1_AGG A
    ON A.COD_CONTRATO = D.COD_CONTRATO
   AND A.DATA_MES     = D.DATA_MES
  LEFT JOIN AF7_FLAG F
    ON F.COD_CONTRATO = D.COD_CONTRATO
   AND F.DATA_MES     = D.DATA_MES
),

/* ====================== BASE MENSAL ====================== */
BASE_MENSAL AS (
  SELECT
    D.COD_CONTRATO,
    D.DATA_MES,
    /* carrega também o organograma ATUAL para agregações/ordenar */
    D.COD_TIPO_ATUAL        AS COD_TIPO,
    D.COD_UNIDADE_ATUAL     AS COD_UNIDADE,
    D.COD_REDE_ATUAL        AS COD_REDE,

    CAST(NVL(H.TOT_HORAS_TRAB, 0)        AS NUMBER) AS TOT_HR_TRAB,
    CAST(NVL(A1.TOT_FALTAS, 0)           AS NUMBER) AS TOT_FALTAS,
    CAST(NVL(A1.TOT_ATESTADOS, 0)        AS NUMBER) AS TOT_ATESTADOS,
    CAST(NVL(A1.TOT_FALTAS_ATESTADOS, 0) AS NUMBER) AS TOT_FT_ATEST,
    CAST(
      CASE WHEN NVL(H.TOT_HORAS_TRAB,0) > 0
           THEN NVL(H.TOT_HORAS_TRAB,0)
           ELSE NVL(D.HR_BASE_MES,0)
      END AS NUMBER
    ) AS TOT_HR_BASE
  FROM DIM D
  LEFT JOIN H  ON H.COD_CONTRATO  = D.COD_CONTRATO AND H.DATA_MES  = D.DATA_MES
  LEFT JOIN A1 ON A1.COD_CONTRATO = D.COD_CONTRATO AND A1.DATA_MES = D.DATA_MES
),

/* ====================== TOTAL POR COLABORADOR (PERÍODO) ====================== */
PERIODO_COLAB AS (
  SELECT
    COD_CONTRATO,
    SUM(TOT_FALTAS)       AS TOT_FALTAS_PERIODO,
    SUM(TOT_ATESTADOS)    AS TOT_ATESTADOS_PERIODO,
    SUM(TOT_HR_TRAB)      AS TOT_HR_TRAB_PERIODO,
    SUM(TOT_FT_ATEST)     AS TOT_FT_ATEST_PERIODO,
    NVL(ROUND( SUM(TOT_FT_ATEST) * 100 / NULLIF(SUM(TOT_HR_BASE),0), 2), 0) AS PERC_ABS_PERIODO
  FROM BASE_MENSAL
  GROUP BY COD_CONTRATO
)

/* ====================== RESULTADO (EXIBE ORGANOGRAMA ATUAL) ====================== */
SELECT
  OA.COD_ORGANOGRAMA_ATUAL    AS COD_ORGANOGRAMA,
  D.COD_CONTRATO,
  D.DES_PESSOA,
  D.DATA_ADMISSAO,
  D.DES_FUNCAO,
  OA.COD_UNIDADE_ATUAL        AS COD_UNIDADE,
  OA.DES_UNIDADE_ATUAL        AS DES_UNIDADE,
  OA.COD_REDE_ATUAL           AS COD_REDE,
  OA.DES_REDE_ATUAL           AS DES_REDE,
  OA.COD_TIPO_ATUAL           AS COD_TIPO,
  D.MES_ANO,
  D.MES_ANO_EXTENSO,

  ROUND(NVL(H.TOT_HORAS_TRAB, 0), 2)        AS TOT_HR_TRAB_UNI,
  ROUND(NVL(A1.TOT_FALTAS, 0), 2)           AS TOT_FALTAS_UNI,
  ROUND(NVL(A1.TOT_ATESTADOS, 0), 2)        AS TOT_ATESTADOS_UNI,
  ROUND(NVL(A1.TOT_FALTAS_ATESTADOS, 0), 2) AS TOT_FT_ATEST_UNI,
  NVL(ROUND(NVL(A1.TOT_FALTAS_ATESTADOS,0) * 100 / NULLIF(BM.TOT_HR_BASE,0), 2), 0) AS PERC_ABSENTEISMO_UNI,

  /* Totais do período (por contrato) */
  ROUND(NVL(P.TOT_FALTAS_PERIODO,   0), 2) AS TOT_FALTAS_PERIODO,
  ROUND(NVL(P.TOT_ATESTADOS_PERIODO,0), 2) AS TOT_ATESTADOS_PERIODO,
  ROUND(NVL(P.TOT_HR_TRAB_PERIODO,  0), 2) AS TOT_HR_TRAB_PERIODO,
  ROUND(NVL(P.TOT_FT_ATEST_PERIODO, 0), 2) AS TOT_FT_ATEST_PERIODO,
  NVL(P.PERC_ABS_PERIODO, 0)               AS PERC_ABSENTEISMO_PERIODO,

  SYSDATE AS DATA_SISTEMA,
  'Tipo: ' || TO_CHAR(:TIPO) || ' | ' ||
  'Filial: ' || TO_CHAR(:FILIAL) || ' | ' ||
  'Rede: ' || TO_CHAR(:REDE) || ' | ' ||
  'Contrato: ' || TO_CHAR(:CONTRATO) || ' | ' ||
  'Data de: ' || TO_CHAR(:DATA_INICIO, 'DD/MM/YYYY') || ' à ' || TO_CHAR(:DATA_FIM, 'DD/MM/YYYY') AS PARAMETROS

FROM DIM D
JOIN ORG_ATUAL OA ON OA.COD_CONTRATO = D.COD_CONTRATO
LEFT JOIN H   ON H.COD_CONTRATO  = D.COD_CONTRATO AND H.DATA_MES  = D.DATA_MES
LEFT JOIN A1  ON A1.COD_CONTRATO = D.COD_CONTRATO AND A1.DATA_MES = D.DATA_MES
LEFT JOIN BASE_MENSAL   BM ON BM.COD_CONTRATO = D.COD_CONTRATO AND BM.DATA_MES = D.DATA_MES
LEFT JOIN PERIODO_COLAB P  ON P.COD_CONTRATO  = D.COD_CONTRATO
ORDER BY
  OA.COD_TIPO_ATUAL, OA.DES_UNIDADE_ATUAL, D.COD_CONTRATO, D.DATA_MES
