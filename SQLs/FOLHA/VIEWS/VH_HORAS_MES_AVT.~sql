CREATE OR REPLACE VIEW VH_HORAS_MES_AVT AS
WITH HORAS_MES AS (
SELECT COD_CONTRATO,
       DES_PESSOA,
       COD_UNIDADE,
       DES_UNIDADE,

       /* data de competência para ordenar/filtrar */
       TRUNC(COMPETENCIA, 'MM') AS MES_DT,

       /* rótulo para exibição */
       TO_CHAR(TRUNC(COMPETENCIA, 'MM'), 'MM/YYYY') AS MES,

       /* somatórios brutos */
       SUM(NUM_HORAS) AS TOTAL_HORAS,
       SUM(NUM_FALTAS) AS TOTAL_FALTAS,
       SUM(NUM_COMPENSAR) AS TOTAL_COMPENSAR,

       --SUM(NUM_ATRASOS)    AS TOTAL_ATRASOS_BRUTO,
       --SUM(NUM_EXTRAS)     AS TOTAL_EXTRAS_BRUTO,

       /* sobras dentro do mês (extras abatem atrasos) */
       GREATEST(0, SUM(NUM_ATRASOS) - SUM(NUM_EXTRAS)) AS TOTAL_ATRASOS,
       GREATEST(0, SUM(NUM_EXTRAS) - SUM(NUM_ATRASOS) - SUM(NUM_COMPENSAR)) AS TOTAL_EXTRAS,

       SUM(NUM_FERIAS) AS TOTAL_FERIAS
  FROM VH_HORAS_DIA_AVT -- use a sua view diária com colunas NUM_*
 GROUP BY TRUNC(COMPETENCIA, 'MM'),
          COD_CONTRATO,
          DES_PESSOA,
          COD_UNIDADE,
          DES_UNIDADE

)

SELECT COD_CONTRATO,
    DES_PESSOA,
    COD_UNIDADE,
    DES_UNIDADE,
    MES_DT,
    MES,
       CASE
         WHEN TOTAL_HORAS < 0 THEN
          '-' || TRUNC(ABS(TOTAL_HORAS)) || ':' ||
          LPAD(ROUND(MOD(ABS(TOTAL_HORAS), 1) * 60), 2, '0')
         ELSE
          TRUNC(TOTAL_HORAS) || ':' || LPAD(ROUND(MOD(TOTAL_HORAS, 1) * 60), 2, '0')
       END AS HORAS,

       CASE
         WHEN TOTAL_FALTAS < 0 THEN
          '-' || TRUNC(ABS(TOTAL_FALTAS)) || ':' ||
          LPAD(ROUND(MOD(ABS(TOTAL_FALTAS), 1) * 60), 2, '0')
         ELSE
          TRUNC(TOTAL_FALTAS) || ':' || LPAD(ROUND(MOD(TOTAL_FALTAS, 1) * 60), 2, '0')
       END AS FALTAS,

       CASE
         WHEN TOTAL_COMPENSAR < 0 THEN
          '-' || TRUNC(ABS(TOTAL_COMPENSAR)) || ':' ||
          LPAD(ROUND(MOD(ABS(TOTAL_COMPENSAR), 1) * 60), 2, '0')
         ELSE
          TRUNC(TOTAL_COMPENSAR) || ':' || LPAD(ROUND(MOD(TOTAL_COMPENSAR, 1) * 60), 2, '0')
       END AS COMPENSAR,

       CASE
         WHEN TOTAL_ATRASOS < 0 THEN
          '-' || TRUNC(ABS(TOTAL_ATRASOS)) || ':' ||
          LPAD(ROUND(MOD(ABS(TOTAL_ATRASOS), 1) * 60), 2, '0')
         ELSE
          TRUNC(TOTAL_ATRASOS) || ':' || LPAD(ROUND(MOD(TOTAL_ATRASOS, 1) * 60), 2, '0')
       END AS ATRASOS,

       CASE
         WHEN TOTAL_EXTRAS < 0 THEN
          '-' || TRUNC(ABS(TOTAL_EXTRAS)) || ':' ||
          LPAD(ROUND(MOD(ABS(TOTAL_EXTRAS), 1) * 60), 2, '0')
         ELSE
          TRUNC(TOTAL_EXTRAS) || ':' || LPAD(ROUND(MOD(TOTAL_EXTRAS, 1) * 60), 2, '0')
       END AS EXTRAS,

       CASE
         WHEN TOTAL_FERIAS < 0 THEN
          '-' || TRUNC(ABS(TOTAL_FERIAS)) || ':' ||
          LPAD(ROUND(MOD(ABS(TOTAL_FERIAS), 1) * 60), 2, '0')
         ELSE
          TRUNC(TOTAL_FERIAS) || ':' || LPAD(ROUND(MOD(TOTAL_FERIAS, 1) * 60), 2, '0')
       END AS FERIAS
FROM HORAS_MES

