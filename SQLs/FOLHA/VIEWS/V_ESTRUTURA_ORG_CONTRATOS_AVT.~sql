CREATE OR REPLACE VIEW V_ESTRUTURA_ORG_CONTRATOS_AVT AS
WITH CONTRATOS AS (
SELECT COD_CONTRATO,
       DATA_INICIO AS DATA_ADMISSAO,
       DATA_FIM AS DATA_DEMISSAO
FROM RHFP0300
WHERE (DATA_FIM IS NULL OR DATA_FIM > SYSDATE)

),

ORGANOGRAMAS AS (
SELECT COD_CONTRATO,
       COD_ORGANOGRAMA,
       COD_UNIDADE,
       DES_UNIDADE,
       DATA_INI_ORG,
       DATA_FIM_ORG,
       COD_REDE AS COD_REDE_LOCAL,
       DES_REDE AS DES_REDE_LOCAL,
       COD_UF AS COD_UF_ORG,
       COD_ORG_1 AS COD_GRUPO_EMP,
       EDICAO_ORG_1 AS EDICAO_GRUPO_EMP,
       NOME1 AS DES_GRUPO_EMP,
       COD_ORG_2 AS COD_EMP,
       EDICAO_ORG_2 AS EDICAO_EMP,
       NOME2 AS DES_EMPRESA,
       COD_ORG_3 AS COD_ORG_FILIAL,
       EDICAO_ORG_3 AS EDICAO_FILIAL,
       NOME3 AS DES_FILIAL,
       COD_ORG_4 AS COD_ORG_DIVISAO,
       EDICAO_ORG_4 AS EDICAO_DIVISAO,
       NOME4 AS DES_DIVISAO,
       COD_ORG_5 AS COD_ORG_DEPART,
       EDICAO_ORG_5 AS EDICAO_DEPART,
       NOME5 AS DES_DEPART,
       COD_ORG_6 AS COD_ORG_SETOR,
       EDICAO_ORG_6 AS EDICAO_SETOR,
       NOME6 AS DES_SETOR,
       COD_ORG_7 AS COD_ORG_SECAO,
       EDICAO_ORG_7 AS EDICAO_SECAO,
       NOME7 AS DES_SECAO,
       COD_ORG_8 AS COD_ORG_UNI,
       EDICAO_ORG_8 AS EDICAO_UNI,
       NOME8 AS DES_UNI,
       COD_TIPO,
       DES_TIPO,
       ROW_NUMBER() OVER(PARTITION BY COD_CONTRATO ORDER BY DATA_INI_ORG DESC) AS RN
  FROM VH_EST_ORG_CONTRATO_AVT
WHERE DATA_FIM_ORG = TO_DATE('31/12/2999', 'DD/MM/YYYY')

),

CONTRATOS_ORGANOGRAMAS AS (
SELECT A.COD_CONTRATO,
       A.DATA_ADMISSAO,
       A.DATA_DEMISSAO,
       B.COD_ORGANOGRAMA,
       B.COD_UNIDADE,
       B.DES_UNIDADE,
       B.DATA_INI_ORG,
       B.DATA_FIM_ORG,
       B.COD_REDE_LOCAL,
       B.DES_REDE_LOCAL,
       B.COD_UF_ORG,
       B.COD_GRUPO_EMP,
       B.EDICAO_GRUPO_EMP,
       B.DES_GRUPO_EMP,
       B.COD_EMP,
       B.EDICAO_EMP,
       B.DES_EMPRESA,
       B.COD_ORG_FILIAL,
       B.EDICAO_FILIAL,
       B.DES_FILIAL,
       B.COD_ORG_DIVISAO,
       B.EDICAO_DIVISAO,
       B.DES_DIVISAO,
       B.COD_ORG_DEPART,
       B.EDICAO_DEPART,
       B.DES_DEPART,
       B.COD_ORG_SETOR,
       B.EDICAO_SETOR,
       B.DES_SETOR,
       B.COD_ORG_SECAO,
       B.EDICAO_SECAO,
       B.DES_SECAO,
       B.COD_ORG_UNI,
       B.EDICAO_UNI,
       B.DES_UNI,
       B.COD_TIPO,
       B.DES_TIPO
FROM CONTRATOS A
INNER JOIN ORGANOGRAMAS B ON A.COD_CONTRATO = B.COD_CONTRATO AND B.RN = 1

)

SELECT "COD_CONTRATO","DATA_ADMISSAO","DATA_DEMISSAO","COD_ORGANOGRAMA","COD_UNIDADE","DES_UNIDADE","DATA_INI_ORG","DATA_FIM_ORG","COD_REDE_LOCAL","DES_REDE_LOCAL","COD_UF_ORG","COD_GRUPO_EMP","EDICAO_GRUPO_EMP","DES_GRUPO_EMP","COD_EMP","EDICAO_EMP","DES_EMPRESA","COD_ORG_FILIAL","EDICAO_FILIAL","DES_FILIAL","COD_ORG_DIVISAO","EDICAO_DIVISAO","DES_DIVISAO","COD_ORG_DEPART","EDICAO_DEPART","DES_DEPART","COD_ORG_SETOR","EDICAO_SETOR","DES_SETOR","COD_ORG_SECAO","EDICAO_SECAO","DES_SECAO","COD_ORG_UNI","EDICAO_UNI","DES_UNI","COD_TIPO","DES_TIPO" FROM CONTRATOS_ORGANOGRAMAS
ORDER BY COD_CONTRATO, COD_UNIDADE

