CREATE OR REPLACE VIEW VH_HISTORICO_CONTRATO_AVT AS
WITH CTE_ORGANOGRAMA AS (
     SELECT DISTINCT
            ORG.*,
            VO.COD_REDE,
            VO.DES_REDE,
            VO.COD_REGIAO,
            VO.DES_REGIAO,
            ROW_NUMBER() OVER(PARTITION BY ORG.COD_CONTRATO ORDER BY ORG.DATA_INICIO DESC) AS RN
     FROM VH_EST_ORG_CONTRATO_ALTER_AVT ORG
     LEFT JOIN V_ORGANOGRAMAS_AVT VO
            ON ORG.COD_ORGANOGRAMA = VO.COD_ORGANOGRAMA
     --WHERE ORG.COD_CONTRATO = 389622
),

CTE_CARGO AS (
     SELECT DISTINCT
            CC.COD_CONTRATO,
            CC.COD_FUNCAO,
            CC.DES_FUNCAO,
            CC.DATA_INI_FUNCAO,
            CC.DATA_FIM_FUNCAO
     FROM VH_HIST_CARGO_CONTRATO_AVT CC
),

CTE_AFAST AS (
     SELECT DISTINCT
            AFAST.COD_CONTRATO,
            AFAST.COD_AFAST,
            AFAST.DES_AFAST,
            AFAST.DATA_INI_AFAST,
            AFAST.DATA_FIM_AFAST,
            AFAST.QTD_DIAS_AFAST,
            ROW_NUMBER() OVER(PARTITION BY AFAST.COD_CONTRATO ORDER BY AFAST.DATA_INI_AFAST DESC) AS RN
     FROM VH_AFAST_CONTRATO_AVT AFAST
     --WHERE AFAST.COD_CONTRATO = 206008
)
SELECT DISTINCT
/* DADOS DO CONTRATO */
 PF.COD_PESSOA,
 CT.COD_CONTRATO,
 INITCAP(PF.NOME_PESSOA) AS DES_PESSOA,
 CT.DATA_INICIO AS DATA_ADMISSAO,
 CT.DATA_FIM AS DATA_DEMISSAO,
 CT.COD_CAUSA_DEMISSAO AS COD_DEMISSAO,
 DEM.NOME_CAUSA_DEMISSAO AS DES_DEMISSAO,

 /* DADOS DA FUNÇÃO */
 FUN.COD_FUNCAO,
 FUN.DES_FUNCAO,
 FUN.DATA_INI_FUNCAO,
 FUN.DATA_FIM_FUNCAO,

 /* DADOS DO ORGANOGRAMA DO CONTRATO */
 ORG.COD_ORGANOGRAMA,
 ORG.EDICAO_ORG AS COD_UNIDADE,
 ORG.EDICAO_ORG || ' - ' || ORG.NOME_ORGANOGRAMA AS DES_UNIDADE,
 ORG.DATA_INICIO AS DATA_INICIO_ORG,
 ORG.DATA_FIM AS DATA_FIM_ORG,
 ORG.COD_REDE AS COD_REDE_LOCAL,
 ORG.DES_REDE AS DES_REDE_LOCAL,
 ORG.COD_REGIAO,
 ORG.DES_REGIAO,
 ORG.COD_ORG_1 AS COD_GRUPO_EMP,
 ORG.EDICAO_ORG_1 AS EDICAO_GRUPO_EMP,
 ORG.NOME1 AS DES_GRUPO_EMP,
 ORG.COD_ORG_2 AS COD_EMP,
 ORG.EDICAO_ORG_2 AS EDICAO_EMP,
 ORG.NOME2 AS DES_EMPRESA,
 ORG.COD_ORG_3 AS COD_ORG_FILIAL,
 ORG.EDICAO_ORG_3 AS EDICAO_FILIAL,
 ORG.NOME3 AS DES_FILIAL,
 ORG.COD_ORG_4 AS COD_ORG_DIVISAO,
 ORG.EDICAO_ORG_4 AS EDICAO_DIVISAO,
 ORG.NOME4 AS DES_DIVISAO,
 ORG.COD_ORG_5 AS COD_ORG_DEPART,
 ORG.EDICAO_ORG_5 AS EDICAO_DEPART,
 ORG.NOME5 AS DES_DEPART,
 ORG.COD_ORG_6 AS COD_ORG_SETOR,
 ORG.EDICAO_ORG_6 AS EDICAO_SETOR,
 ORG.NOME6 AS DES_SETOR,
 ORG.COD_ORG_7 AS COD_ORG_SECAO,
 ORG.EDICAO_ORG_7 AS EDICAO_SECAO,
 ORG.NOME7 AS DES_SECAO,
 ORG.COD_ORG_8 AS COD_ORG_UNI,
 ORG.EDICAO_ORG_8 AS EDICAO_UNI,
 ORG.NOME8 AS DES_UNI,
 ORG.DATA_INI_SUB,
 ORG.DATA_FIM_SUB,
 ORG.COD_TIPO,
 ORG.DES_TIPO,

 /* DADOS DE AFASTAMENTOS */
 AFAST.COD_AFAST,
 AFAST.DES_AFAST,
 AFAST.DATA_INI_AFAST,
 AFAST.DATA_FIM_AFAST,
 AFAST.QTD_DIAS_AFAST

  FROM RHFP0300 CT
 INNER JOIN PESSOA_FISICA PF ON CT.COD_FUNC = PF.COD_PESSOA
  LEFT JOIN RHFP0102 DEM ON CT.COD_CAUSA_DEMISSAO = DEM.COD_CAUSA_DEMISSAO

-- DADOS DO CARGO DO CONTRATO
  LEFT JOIN CTE_CARGO FUN ON CT.COD_CONTRATO = FUN.COD_CONTRATO

-- DADOS DO ORGANOGRAMA DO CONTRATO
  LEFT JOIN CTE_ORGANOGRAMA ORG ON CT.COD_CONTRATO = ORG.COD_CONTRATO
                                --AND ORG.RN = 1

-- DADOS DE AFASTAMENTO
  LEFT JOIN CTE_AFAST AFAST ON CT.COD_CONTRATO = AFAST.COD_CONTRATO
                           AND AFAST.RN = 1

 WHERE (CT.DATA_FIM IS NULL OR
       SYSDATE BETWEEN CT.DATA_INICIO AND
       NVL(CT.DATA_FIM, TO_DATE('31/12/2999', 'DD/MM/YYYY')) OR
       CT.DATA_FIM >= SYSDATE - 1850)
 --AND CT.COD_CONTRATO = 206008
 ORDER BY CT.COD_CONTRATO, ORG.DATA_INICIO, FUN.DATA_INI_FUNCAO

