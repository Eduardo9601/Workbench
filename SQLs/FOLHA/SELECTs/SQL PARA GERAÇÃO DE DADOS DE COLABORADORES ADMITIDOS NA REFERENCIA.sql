WITH CONTRATOS AS (
SELECT COD_CONTRATO,
       DES_PESSOA,
       DATA_NASCIMENTO,
       IDADE,
       SEXO,
       DES_EST_CIVIL,
       CASE
           WHEN DES_DEFICIENCIA IS NOT NULL THEN
            DES_DEFICIENCIA
           ELSE
            'Não Contém'
       END AS DEFICIENCIA,
       SUBSTR(CPF, 1, 3) || '.' || SUBSTR(cpf, 4, 3) || '.' ||
       SUBSTR(CPF, 7, 3) || '-' || SUBSTR(cpf, 10, 2) AS CPF,
       NRO_IDENTIDADE || ' ' || EMISSOR AS IDENTIDADE,
       NRO_PIS_PASEP,
       CTPS,
       NACIONALIDADE,
       DES_RACA_COR,
       COD_CEP AS CEP,
       DES_LOGRA,
       NUMERO,
       DES_BAIRRO,
       DES_CIDADE,
       COD_UF,
       CASE
           WHEN DES_PAI IS NOT NULL THEN
            DES_PAI
           ELSE
            'Não Contém Informação'
       END AS PAI,
       CASE
           WHEN DES_PAI IS NOT NULL THEN
            DES_MAE
           ELSE
            'Não Contém Informação'
       END AS MAE,


       --DADOS CONTRATUAIS
       DATA_ADMISSAO,
       DES_FUNCAO,
       DATA_INICIO_CLH,
       DATA_FIM_CLH,
       HR_BASE_MES,
       HR_BASE_SEM,
       HR_BASE_DIA,
       DATA_INICIO_HR,
       DATA_FIM_HR,
       IND_BATE_PONTO,
       CASE
         WHEN COD_SINDICATO IS NOT NULL THEN
          COD_SINDICATO || ' - ' || DES_SINDICATO
         ELSE
          'Não Contém Informação'
       END AS SINDICATO,
       IND_CONT_SINDICAL,
       DATA_INI_SIND,
       DATA_FIM_SIND,
       CONTA_BANCARIA,
       DES_BANCO,
       COD_UNIDADE,
       DES_UNIDADE,
       DATA_INI_ORG,
       DATA_FIM_ORG,
       COD_REDE_LOCAL,
       DES_REDE_LOCAL,
       COD_TIPO,
       DES_TIPO
  FROM V_DADOS_COLAB_AVT
 WHERE DATA_ADMISSAO BETWEEN :ADMISSAO_INICIO AND :ADMISSAO_FIM
   AND COD_EMP = 8
   --AND COD_CONTRATO = 397017

),

INFORMACOES_CONTRATO AS (
SELECT
  COD_CONTRATO,
  MAX(CASE WHEN COD_CAMPO = 5 THEN CONT_ALFA END) AS INFO_HOR_5,
  MAX(CASE WHEN COD_CAMPO = 6 THEN CONT_ALFA END) AS INFO_HOR_6,
  MAX(CASE WHEN COD_CAMPO = 7 THEN CONT_ALFA END) AS INFO_HOR_7,
  MAX(CASE WHEN COD_CAMPO = 8 THEN CONT_ALFA END) AS INFO_HOR_8
FROM RHFP0308
WHERE COD_CAMPO IN (5, 6, 7, 8)
  --AND COD_CONTRATO = 396890
GROUP BY COD_CONTRATO
),

HORARIOS AS (
SELECT A.COD_CONTRATO,
       A.DATA_INICIO AS DATA_INICIO_HOR,
       A.DATA_FIM AS DATA_FIM_HOR,
       A.COD_TURNO,
       D.NOME_TURNO AS DES_TURNO,
       A.COD_MOTIVO,
       B.NOME_MOTIVO,
       A.TIPO_TURNO,
       DECODE(D.HORARIO_1_ENT,
              NULL,
              NULL,
              LPAD(RHYF0118(RHYF0117(D.HORARIO_1_ENT), 'S'), 5, '0')) AS HOR_1_ENT,
       DECODE(D.HORARIO_1_SAI,
              NULL,
              NULL,
              LPAD(RHYF0118(RHYF0117(D.HORARIO_1_SAI), 'S'), 5, '0')) AS HOR_1_SAI,
       DECODE(D.HORARIO_2_ENT,
              NULL,
              NULL,
              LPAD(RHYF0118(RHYF0117(D.HORARIO_2_ENT), 'S'), 5, '0')) AS HOR_2_ENT,
       DECODE(D.HORARIO_2_SAI,
              NULL,
              NULL,
              LPAD(RHYF0118(RHYF0117(D.HORARIO_2_SAI), 'S'), 5, '0')) AS HOR_2_SAI,
       DECODE(D.HORARIO_3_ENT,
              NULL,
              NULL,
              LPAD(RHYF0118(RHYF0117(D.HORARIO_3_ENT), 'S'), 5, '0')) AS HOR_3_ENT,
       DECODE(D.HORARIO_3_SAI,
              NULL,
              NULL,
              LPAD(RHYF0118(RHYF0117(D.HORARIO_3_SAI), 'S'), 5, '0')) AS HOR_3_SAI,
       DECODE(D.HORARIO_4_ENT,
              NULL,
              NULL,
              LPAD(RHYF0118(RHYF0117(D.HORARIO_4_ENT), 'S'), 5, '0')) AS HOR_4_ENT,
       DECODE(D.HORARIO_4_SAI,
              NULL,
              NULL,
              LPAD(RHYF0118(RHYF0117(D.HORARIO_4_SAI), 'S'), 5, '0')) AS HOR_4_SAI
  FROM RHAF1119 A, RHFP0323 B, RHFP0115 C, RHAF1145 D, RHAF1103 F
 WHERE A.COD_MOTIVO = B.COD_MOTIVO(+)
   AND B.COD_TIPO_MOTIVO = C.COD_TIPO_MOTIVO(+)
   AND A.COD_TURNO = D.COD_TURNO(+)
   AND D.COD_CLASSE_TURNO = F.COD_CLASSE_TURNO(+)
   AND :ADMISSAO_FIM BETWEEN A.DATA_INICIO AND A.DATA_FIM
   --AND a.COD_CONTRATO = 397017

),

CONTRATO_EXPERIENCIA AS (
SELECT
  RHFP0304.COD_CONTRATO,
  RHFP0304.DATA_INICIO AS DATA_INI_EXP,
  RHFP0304.DATA_FIM AS DATA_FIM_EXP,
  TO_NUMBER(TRUNC(RHFP0304.DATA_FIM - RHFP0304.DATA_INICIO)+1) AS DIAS_CONTRATO,
  RHFP0305.DATA_AVALIACAO,
  RHFP0305.IND_AVALIACAO,
  RHFP0314.NUM_DIAS,
  RHFP0314.IND_AVALIACOES,
  RHFP0116.NOME_TIPO_CONTRATO,
  RHFP0116.DURACAO_CONTRATO
FROM RHFP0304 RHFP0304,
     RHFP0305 RHFP0305,
     RHFP0314 RHFP0314,
     RHFP0116 RHFP0116
WHERE :ADMISSAO_FIM BETWEEN RHFP0304.DATA_INICIO AND RHFP0304.DATA_FIM
  AND RHFP0305.COD_CONTRATO(+) = RHFP0304.COD_CONTRATO
  AND RHFP0305.DATA_INICIO(+) = RHFP0304.DATA_INICIO
  AND RHFP0304.COD_TP_CONTRATO = RHFP0314.COD_TP_CONTRATO
  AND RHFP0314.COD_TIPO_CONTRATO = RHFP0116.COD_TIPO_CONTRATO

),

SALARIOS AS (
SELECT COD_CONTRATO,
       TO_CHAR(VALOR_SALARIO, 'FM999G999G990D00') AS SALARIO,
       DATA_INICIO AS DATA_INI_SAL,
       DATA_FIM AS DATA_FIM_SAL,
       TIPO_SALARIO,
       DECODE(TIPO_SALARIO,'M','Mês','H','Hora','') AS NOME_TIPO_SALARIO
FROM RHFP0608
WHERE :ADMISSAO_FIM BETWEEN DATA_INICIO AND DATA_FIM
--AND COD_CONTRATO = 397017

),

ANTECIPACAO AS (
SELECT RHFP1006.COD_CONTRATO,
       RHFP1006.COD_MESTRE_EVENTO,
       ROUND(RHFP1006.VALOR_VD, 2) AS VALOR_ANTE,
       ROUND(RHFP1006.QTDE_VD, 2) AS QTDE_VD,
       RHFP1006.COD_VD
  FROM RHFP1006 RHFP1006,
       (SELECT RHFP1003.COD_MESTRE_EVENTO,
               RHFP1003.DATA_REFERENCIA,
               RHFP1003.COD_EVENTO,
               RHFP1003.DATA_PAGAMENTO,
               RHFP1003.DATA_INI_MOV,
               RHFP1003.DATA_FIM_MOV,
               RHFP1003.DATA_PROCESSO,
               RHFP1003.DATA_INCORPORACAO,
               RHFP1003.SITUACAO_PROCESSO,
               RHFP1003.IND_CONTABIL,
               RHFP1003.DATA_APROPRIACAO,
               RHFP1003.COD_ORGANOGRAMA,
               RHFP1003.NOME_MESTRE_EVENTO,
               RHFP1002.NOME_EVENTO
          FROM RHFP1003 RHFP1003, RHFP1002 RHFP1002
         WHERE RHFP1003.SITUACAO_PROCESSO = 'I'
           AND RHFP1003.COD_EVENTO = RHFP1002.COD_EVENTO
           AND RHFP1003.DATA_REFERENCIA BETWEEN :ADMISSAO_INICIO AND
               :ADMISSAO_FIM) MESTRE
 WHERE MESTRE.COD_MESTRE_EVENTO = RHFP1006.COD_MESTRE_EVENTO
   AND RHFP1006.COD_VD IN (905)
   --AND RHFP1006.COD_CONTRATO = 397017


),

DEPENDENTES AS (
SELECT RHFP0300.COD_CONTRATO,
       RHFP0202.COD_FUNC,
       RHFP0202.COD_PESSOA AS COD_DEPEN,
       PESSOA.NOME_PESSOA AS DES_DEPEN,
       FISICA.CPF AS CPF_DEPEN,
       RHFP0202.DATA_INICIO,
       RHFP0202.DATA_FIM,
       RHFP0202.COD_GRAU_PARENTESCO AS COD_PARENT,
       RHFP0106.NOME_GRAU_PARENTESCO AS GRAU_PARENT,
       RHFP0202.COD_NACIONALIDADE,
       RHFP0107.NOME_NACIONALIDADE,
       RHFP0105.NOME_RESUMIDO,
       RHFP0202.SEXO AS SEXO_PARENT,
       RHFP0202.COD_ESTADO_CIVIL,
       RHFP0104.NOME_ESTADO_CIVIL,
       RHFP0202.TIPO_DEPENDENTE,
       RHFP0109.NOME_TIPO_DEPENDENTE,
       RHFP0202.IRF,
       RHFP0202.SAL_FAMILIA,
       RHFP0202.DATA_NASCIMENTO AS DT_NASC_DEPEN,
       TRUNC(MONTHS_BETWEEN(:ADMISSAO_FIM, RHFP0202.DATA_NASCIMENTO) / 12) AS IDADE_DEPEN
  FROM FISICA   FISICA,
       PESSOA   PESSOA,
       RHFP0300 RHFP0300,
       RHFP0202 RHFP0202,
       RHFP0106 RHFP0106,
       RHFP0107 RHFP0107,
       RHFP0105 RHFP0105,
       RHFP0104 RHFP0104,
       RHFP0109 RHFP0109,
       MUNICI   MUNICI,
       UF       UF
 WHERE RHFP0202.COD_FUNC = RHFP0300.COD_FUNC
   AND RHFP0202.COD_PESSOA = PESSOA.COD_PESSOA
   AND RHFP0202.COD_GRAU_PARENTESCO = RHFP0106.COD_GRAU_PARENTESCO(+)
   AND RHFP0202.COD_NACIONALIDADE = RHFP0107.COD_NACIONALIDADE(+)
   AND RHFP0202.COD_GRAU_INSTRUCAO = RHFP0105.COD_GRAU_INSTRUCAO(+)
   AND RHFP0202.COD_ESTADO_CIVIL = RHFP0104.COD_ESTADO_CIVIL(+)
   AND RHFP0202.TIPO_DEPENDENTE = RHFP0109.COD_TIPO_DEPENDENTE(+)
   AND RHFP0202.COD_UF_NASCIMENTO = UF.COD_UF(+)
   AND RHFP0202.COD_UF_NASCIMENTO = MUNICI.COD_UF(+)
   AND RHFP0202.COD_MUNIC_NASCIMENTO = MUNICI.COD_MUNIC(+)
   AND PESSOA.COD_PESSOA = FISICA.COD_PESSOA(+)
   AND :ADMISSAO_FIM BETWEEN RHFP0202.DATA_INICIO AND RHFP0202.DATA_FIM
   --AND RHFP0300.COD_CONTRATO = 396870

),

QTD_CONTRATOS_DISTINCT AS (
  SELECT COUNT(DISTINCT A.COD_CONTRATO) AS QTD_TOTAL
  FROM CONTRATOS A
  JOIN SALARIOS B ON A.COD_CONTRATO = B.COD_CONTRATO
  LEFT JOIN ANTECIPACAO C ON A.COD_CONTRATO = C.COD_CONTRATO
  LEFT JOIN DEPENDENTES D ON A.COD_CONTRATO = D.COD_CONTRATO
  LEFT JOIN HORARIOS E ON A.COD_CONTRATO = E.COD_CONTRATO
  WHERE (A.COD_TIPO = :TIPO OR :TIPO = 0)
    AND (A.COD_UNIDADE = :FILIAL OR :FILIAL = 0)
    AND (A.COD_REDE_LOCAL = TO_CHAR(:REDE) OR TO_CHAR(:REDE) = 0)
    AND (A.SEXO = TO_CHAR(:SEXO) OR TO_CHAR(:SEXO) = '0')

)

SELECT A.*,
       E.HOR_1_ENT,
       E.HOR_1_SAI,
       E.HOR_2_ENT,
       E.HOR_2_SAI,
       E.HOR_3_ENT,
       E.HOR_3_SAI,
       E.HOR_4_ENT,
       E.HOR_4_SAI,
       G.INFO_HOR_5,
       G.INFO_HOR_6,
       G.INFO_HOR_7,
       G.INFO_HOR_8,
       B.SALARIO,
       C.VALOR_ANTE,
       F.NUM_DIAS AS DIAS_CONT_EXP,
       F.DATA_INI_EXP,
       F.DATA_FIM_EXP,
       CASE
          WHEN D.DES_DEPEN IS NOT NULL THEN
           REGEXP_SUBSTR(D.DES_DEPEN, '^\S+') || -- Primeiro nome completo
          
          -- Segundo nome abreviado, se existir
           CASE
          WHEN REGEXP_SUBSTR(D.DES_DEPEN, '^\S+\s+(\S+)', 1, 1, NULL, 1) IS NOT NULL THEN
           ' ' ||
           SUBSTR(REGEXP_SUBSTR(D.DES_DEPEN, '^\S+\s+(\S+)', 1, 1, NULL, 1), 1, 1) || '.'
          ELSE
           ''
        END ||
       
       -- Se houver ao menos 3 nomes (ou seja, existe 1 sobrenome ou mais)
        CASE
          WHEN REGEXP_SUBSTR(D.DES_DEPEN, '^(\S+\s+){2}(\S+)', 1, 1, NULL, 2) IS NOT NULL AND
               REGEXP_SUBSTR(D.DES_DEPEN, '^(\S+\s+){3}(\S+)', 1, 1, NULL, 2) IS NOT NULL THEN
           ' ' ||
           SUBSTR(REGEXP_SUBSTR(D.DES_DEPEN, '^(\S+\s+){2}(\S+)', 1, 1, NULL, 2),
                  1,
                  1) || '.' || ' ' ||
           REGEXP_SUBSTR(D.DES_DEPEN, '^(\S+\s+){3}(.*)$', 1, 1, NULL, 2)
          WHEN REGEXP_SUBSTR(D.DES_DEPEN, '^(\S+\s+){2}(\S+)', 1, 1, NULL, 2) IS NOT NULL THEN
           ' ' || REGEXP_SUBSTR(D.DES_DEPEN, '^(\S+\s+){2}(\S+)', 1, 1, NULL, 2)
          ELSE
           ''
        END
       
       ELSE 'Não Contém Informação' END AS DEPENDENTE,
       D.GRAU_PARENT,
       D.SEXO_PARENT,
       D.DT_NASC_DEPEN,
       D.IDADE_DEPEN,
       (SELECT QTD_TOTAL FROM QTD_CONTRATOS_DISTINCT) AS QTD_CONTRATOS,
       'De ' || :ADMISSAO_INICIO || ' à ' || :ADMISSAO_FIM AS PERIODO_GERACAO
  FROM CONTRATOS A
  JOIN SALARIOS B ON A.COD_CONTRATO = B.COD_CONTRATO
  LEFT JOIN ANTECIPACAO C ON A.COD_CONTRATO = C.COD_CONTRATO
  LEFT JOIN DEPENDENTES D ON A.COD_CONTRATO = D.COD_CONTRATO
  LEFT JOIN HORARIOS E ON A.COD_CONTRATO = E.COD_CONTRATO
  LEFT JOIN CONTRATO_EXPERIENCIA F ON A.COD_CONTRATO = F.COD_CONTRATO
  LEFT JOIN INFORMACOES_CONTRATO G ON A.COD_CONTRATO = G.COD_CONTRATO
 WHERE (A.COD_TIPO = :TIPO OR :TIPO = 0)
   AND (A.COD_UNIDADE = :FILIAL OR :FILIAL = 0)
   AND (A.COD_REDE_LOCAL = TO_CHAR(:REDE) OR TO_CHAR(:REDE) = 0)
   AND (A.SEXO = TO_CHAR(:SEXO) OR TO_CHAR(:SEXO) = '0')
--AND A.COD_CONTRATO = 396901