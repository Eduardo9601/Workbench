WITH ANTERIOR AS (
    SELECT 
        A1.COD_CONTRATO,
        MAX(CASE WHEN A1.COD_VD = 2117 THEN A1.COD_VD END) AS VD_2117,
        MAX(CASE WHEN A1.COD_VD = 2117 THEN A1.VALOR_VD END) AS VLR_VD_2117,
        MAX(CASE WHEN A1.COD_VD = 2127 THEN A1.COD_VD END) AS VD_2127,
        MAX(CASE WHEN A1.COD_VD = 2127 THEN A1.VALOR_VD END) AS VLR_VD_2127,
        MAX(CASE WHEN A1.COD_VD = 2137 THEN A1.COD_VD END) AS VD_2137,
        MAX(CASE WHEN A1.COD_VD = 2137 THEN A1.VALOR_VD END) AS VLR_VD_2137
    FROM RHFP1006 A1
    INNER JOIN RHFP1003 B2 
        ON A1.COD_MESTRE_EVENTO = B2.COD_MESTRE_EVENTO
    WHERE B2.COD_MESTRE_EVENTO = 17499  -- Janeiro/2025
      AND A1.COD_VD IN (2117, 2127, 2137) -- VDs do mês anterior
      AND A1.COD_CONTRATO = 389622
    GROUP BY A1.COD_CONTRATO
),

ATUAL AS (
    SELECT 
        A.COD_CONTRATO,
        MAX(CASE WHEN A.COD_VD = 2111 THEN A.COD_VD END) AS VD_2111,
        MAX(CASE WHEN A.COD_VD = 2111 THEN A.VALOR_VD END) AS VLR_VD_2111,
        MAX(CASE WHEN A.COD_VD = 2121 THEN A.COD_VD END) AS VD_2121,
        MAX(CASE WHEN A.COD_VD = 2121 THEN A.VALOR_VD END) AS VLR_VD_2121,
        MAX(CASE WHEN A.COD_VD = 2131 THEN A.COD_VD END) AS VD_2131,
        MAX(CASE WHEN A.COD_VD = 2131 THEN A.VALOR_VD END) AS VLR_VD_2131
    FROM RHFP1005 A
    INNER JOIN RHFP1003 B 
        ON A.COD_MESTRE_EVENTO = B.COD_MESTRE_EVENTO
    WHERE B.COD_MESTRE_EVENTO = 17577  -- Fevereiro/2025
      AND A.COD_VD IN (2111, 2121, 2131) -- VDs do mês anterior
      AND A.COD_CONTRATO = 389622
    GROUP BY A.COD_CONTRATO

)

SELECT COALESCE(AT.COD_CONTRATO, ATU.COD_CONTRATO) AS COD_CONTRATO,
       AT.VD_2117 AS VD_2117_ANT,
       AT.VLR_VD_2117 AS VLR_VD_2117_ANT,
       ATU.VD_2111 AS VD_2111_ATU,
       ATU.VLR_VD_2111 AS VLR_VD_2111_ATU,
       
       AT.VD_2127 AS VD_2127_ANT,
       AT.VLR_VD_2127 AS VLR_VD_2127_ANT,
       ATU.VD_2121 AS VD_2121_ATU,
       ATU.VLR_VD_2121 AS VLR_VD_2121_ATU,
       
       AT.VD_2137 AS VD_2137_ANT,
       AT.VLR_VD_2137 VLR_VD_2137_ANT,
       ATU.VD_2131 AS VD_2131_ATU,
       ATU.VLR_VD_2131 AS VLR_VD_2131_ATU
FROM ANTERIOR AT
JOIN ATUAL ATU ON AT.COD_CONTRATO = ATU.COD_CONTRATO;
