/*RELATÓRIO CNFERÊNCIA VALORES DAS PROVISÕES FÉRIAS - DIFERENÇAS*/
WITH ANTERIOR AS (
    SELECT
        A1.COD_CONTRATO,
        MAX(CASE WHEN A1.COD_VD = 2217 THEN A1.COD_VD END) AS VD_2217,
        MAX(CASE WHEN A1.COD_VD = 2217 THEN A1.VALOR_VD END) AS VLR_VD_2217,
        MAX(CASE WHEN A1.COD_VD = 2227 THEN A1.COD_VD END) AS VD_2227,
        MAX(CASE WHEN A1.COD_VD = 2227 THEN A1.VALOR_VD END) AS VLR_VD_2227,
        MAX(CASE WHEN A1.COD_VD = 2237 THEN A1.COD_VD END) AS VD_2237,
        MAX(CASE WHEN A1.COD_VD = 2237 THEN A1.VALOR_VD END) AS VLR_VD_2237
    FROM RHFP1006 A1
    INNER JOIN RHFP1003 B2
        ON A1.COD_MESTRE_EVENTO = B2.COD_MESTRE_EVENTO
    WHERE B2.DATA_REFERENCIA BETWEEN :DATA_ANTERIOR_INI AND :DATA_ANTERIOR_FIM
      --AND B2.COD_MESTRE_EVENTO = 17499 -- Janeiro/2025
      AND A1.COD_VD IN (2217, 2227, 2237) -- VDs do mês anterior
      AND B2.COD_EVENTO = 21
      AND B2.COD_ORGANOGRAMA = 8
      --AND A1.COD_CONTRATO = 389622
    GROUP BY A1.COD_CONTRATO
),

ATUAL AS (
    SELECT
        A.COD_CONTRATO,
        MAX(CASE WHEN A.COD_VD = 2211 THEN A.COD_VD END) AS VD_2211,
        MAX(CASE WHEN A.COD_VD = 2211 THEN A.VALOR_VD END) AS VLR_VD_2211,
        MAX(CASE WHEN A.COD_VD = 2221 THEN A.COD_VD END) AS VD_2221,
        MAX(CASE WHEN A.COD_VD = 2221 THEN A.VALOR_VD END) AS VLR_VD_2221,
        MAX(CASE WHEN A.COD_VD = 2231 THEN A.COD_VD END) AS VD_2231,
        MAX(CASE WHEN A.COD_VD = 2231 THEN A.VALOR_VD END) AS VLR_VD_2231
    FROM RHFP1005 A
    INNER JOIN RHFP1003 B
        ON A.COD_MESTRE_EVENTO = B.COD_MESTRE_EVENTO
    WHERE B.DATA_REFERENCIA BETWEEN :DATA_ATUAL_INI AND :DATA_ATUAL_FIM
      --AND B.COD_MESTRE_EVENTO = 17577  -- Fevereiro/2025
      AND B.COD_EVENTO = 21
      AND A.COD_VD IN (2211, 2221, 2231) -- VDs do mês anterior
      AND B.COD_ORGANOGRAMA = 8
      --AND A.COD_CONTRATO = 389622
    GROUP BY A.COD_CONTRATO

)

SELECT DISTINCT
       COALESCE(AT.COD_CONTRATO, ATU.COD_CONTRATO) AS COD_CONTRATO,
       AVT.DES_PESSOA,
       AVT.DES_UNIDADE,
       AVT.COD_TIPO,
       AT.VD_2217 AS VD_2217_ANT,
       AT.VLR_VD_2217 AS VLR_VD_2217_ANT,
       ATU.VD_2211 AS VD_2211_ATU,
       ATU.VLR_VD_2211 AS VLR_VD_2211_ATU,

       AT.VD_2227 AS VD_2227_ANT,
       AT.VLR_VD_2227 AS VLR_VD_2227_ANT,
       ATU.VD_2221 AS VD_2221_ATU,
       ATU.VLR_VD_2221 AS VLR_VD_2221_ATU,

       AT.VD_2237 AS VD_2237_ANT,
       AT.VLR_VD_2237 VLR_VD_2237_ANT,
       ATU.VD_2231 AS VD_2231_ATU,
       ATU.VLR_VD_2231 AS VLR_VD_2231_ATU,

       -- Colunas para diferenças
    CASE
        WHEN NVL(AT.VLR_VD_2217, 0) <> NVL(ATU.VLR_VD_2211, 0)
        THEN ABS(NVL(AT.VLR_VD_2217, 0) - NVL(ATU.VLR_VD_2211, 0))
        ELSE 0
    END AS DIF_VLR_2217_2211,

    CASE
        WHEN NVL(AT.VLR_VD_2227, 0) <> NVL(ATU.VLR_VD_2221, 0)
        THEN ABS(NVL(AT.VLR_VD_2227, 0) - NVL(ATU.VLR_VD_2221, 0))
        ELSE 0
    END AS DIF_VLR_2227_2221,

    CASE
        WHEN NVL(AT.VLR_VD_2237, 0) <> NVL(ATU.VLR_VD_2231, 0)
        THEN ABS(NVL(AT.VLR_VD_2237, 0) - NVL(ATU.VLR_VD_2231, 0))
        ELSE 0
    END AS DIF_VLR_2237_2231
FROM ANTERIOR AT
LEFT JOIN ATUAL ATU ON AT.COD_CONTRATO = ATU.COD_CONTRATO
INNER JOIN V_DADOS_COLAB_AVT AVT ON AT.COD_CONTRATO = AVT.COD_CONTRATO
--WHERE AT.COD_CONTRATO IN (322644, 372102, 385229)
ORDER BY AVT.COD_TIPO,
         AVT.DES_UNIDADE,
         AVT.DES_PESSOA
