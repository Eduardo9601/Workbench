

WITH
PARAMETROS AS (
/*PARÂMETROS OFICIAIS DE DATAS PARA SER USADO COMO VARIÁVEL NO PL/SQL*/
/*SELECT
  TO_CHAR(TO_DATE('&DATA_INICIO','DD/MM/YYYY'),'DD/MM/YYYY') AS DATA_INICIO,
  TO_CHAR(TO_DATE('&DATA_FIM','DD/MM/YYYY'),'DD/MM/YYYY') AS DATA_FIM,

  TO_CHAR(TO_DATE('&DATA_INICIO','DD/MM/YYYY'),'DD/MM/YYYY')
  || ' - ' ||
  TO_CHAR(TO_DATE('&DATA_FIM','DD/MM/YYYY'),'DD/MM/YYYY') AS REFERENCIA
FROM dual

SELECT
  TO_CHAR(&DATA_INICIO,'DD/MM/YYYY') AS DATA_INICIO,
  TO_CHAR(&DATA_FIM,'DD/MM/YYYY') AS DATA_INICIO,

  TO_CHAR(&DATA_INICIO,'DD/MM/YYYY')
  || ' - ' ||
  TO_CHAR(&DATA_FIM,'DD/MM/YYYY') AS REFERENCIA
FROM dual*/

SELECT :DATA_INICIO AS DATA_INICIO,
       LAST_DAY(:DATA_FIM) AS DATA_FIM,
       
       :DATA_INICIO
       || ' - ' ||
       :DATA_FIM AS REFERENCIA,

       --ex: 07/2025  (se for um único mês)  ou  07/2025 - 08/2025 (se cruzar mês)
       CASE
         WHEN TRUNC(:DATA_INICIO, 'MM') = TRUNC(:DATA_FIM, 'MM') THEN
          TO_CHAR(:DATA_INICIO, 'MM/YYYY')
         ELSE
          TO_CHAR(:DATA_INICIO, 'MM/YYYY') || ' - ' ||
          TO_CHAR(:DATA_FIM, 'MM/YYYY')
       END AS MES_ANO,

       --ex: Julho/2025  (único mês)  ou  Julho/2025 - Agosto/2025 (intervalo)
       CASE
         WHEN TRUNC(:DATA_INICIO, 'MM') = TRUNC(:DATA_FIM, 'MM') THEN
          INITCAP(TO_CHAR(:DATA_INICIO,
                          'FMMonth',
                          'NLS_DATE_LANGUAGE=Portuguese')) || '/' ||
          TO_CHAR(:DATA_INICIO, 'YYYY')
         ELSE
          INITCAP(TO_CHAR(:DATA_INICIO,
                          'FMMonth',
                          'NLS_DATE_LANGUAGE=Portuguese')) || '/' ||
          TO_CHAR(:DATA_INICIO, 'YYYY') || ' - ' ||
          INITCAP(TO_CHAR(:DATA_FIM,
                          'FMMonth',
                          'NLS_DATE_LANGUAGE=Portuguese')) || '/' ||
          TO_CHAR(:DATA_FIM, 'YYYY')
       END AS MES_ANO_EXTENSO

  FROM DUAL

),


CONTRATOS AS (
SELECT DISTINCT CT.STATUS,
                CT.COD_CONTRATO,
                CT.DES_PESSOA,
                CT.DATA_NASCIMENTO,
                CT.DATA_ADMISSAO,
                CT.DATA_DEMISSAO,
                CT.COD_VINCULO_EMPREG,
                FN.COD_FUNCAO,
                FN.DES_FUNCAO,
                FN.DATA_INI_CLH,
                FN.DATA_FIM_CLH,
                HR.HR_BASE_MES,
                HR.DATA_INI_HR,
                HR.DATA_FIM_HR,
                CT.IND_DEFICIENCIA,
                CT.SEXO,
                ORG.COD_EMP,
                ORG.EDICAO_EMP,
                ORG.DES_EMP,
                ORG.COD_ORGANOGRAMA,
                ORG.COD_UNIDADE,
                ORG.DES_UNIDADE,
                ORG.DATA_INI_ORG,
                ORG.DATA_FIM_ORG,
                CASE
                  WHEN ORG.COD_TIPO = 2 THEN
                   ORG.EDICAO_ORG_3
                  WHEN ORG.COD_TIPO = 3 THEN
                   ORG.EDICAO_ORG_3
                  ELSE
                   ORG.COD_UNIDADE
                END AS COD_FILIAL,
                CASE
                  WHEN ORG.COD_TIPO = 2 THEN
                   ORG.NOME3
                  WHEN ORG.COD_TIPO = 3 THEN
                   ORG.NOME3
                  ELSE
                   ORG.DES_UNIDADE
                END AS DES_FILIAL,
                CASE
                  WHEN ORG.COD_TIPO = 2 THEN
                   ORG.EDICAO_ORG_4
                  WHEN ORG.COD_TIPO = 3 THEN
                   ORG.EDICAO_ORG_4
                  ELSE
                   ORG.COD_UNIDADE
                END AS COD_DIVISAO,
                CASE
                  WHEN ORG.COD_TIPO = 2 THEN
                   ORG.NOME4
                  WHEN ORG.COD_TIPO = 3 THEN
                   ORG.NOME4
                  ELSE
                   ORG.DES_UNIDADE
                END AS DES_DIVISAO,
                ORG.COD_REDE,
                ORG.DES_REDE,
                ORG.COD_TIPO,
                ORG.DES_TIPO
 FROM V_DADOS_CONTRATO_AVT    CT,
      VH_EST_ORG_CONTRATO_AVT ORG,
      VH_HIST_HORAS_COLAB_AVT HR,
      VH_CARGO_CONTRATO_AVT FN,
      PARAMETROS P
 WHERE CT.COD_CONTRATO = ORG.COD_CONTRATO
   AND CT.COD_CONTRATO = HR.COD_CONTRATO
   AND CT.COD_CONTRATO = FN.COD_CONTRATO
   AND (CT.DATA_DEMISSAO IS NULL OR
        CT.DATA_DEMISSAO >= P.DATA_INICIO) --VESÃO ALTERNATIVA, PARA RETORNAR ATÉ QUEM JÁ FOI DEMITIDO ATÉ A DATA_DEMISSAO*/
   /*AND ((P.DATA_FIM BETWEEN CT.DATA_ADMISSAO AND CT.DATA_DEMISSAO) OR
        (CT.DATA_ADMISSAO <= P.DATA_FIM AND CT.DATA_DEMISSAO IS NULL))*/ --VERSÃO PARA RETORNAR SOMENTE ATIVOS NO PERÍODO
   AND P.DATA_FIM BETWEEN ORG.DATA_INI_ORG AND ORG.DATA_FIM_ORG
   AND P.DATA_FIM BETWEEN FN.DATA_INI_CLH AND FN.DATA_FIM_CLH
   AND P.DATA_FIM BETWEEN HR.DATA_INI_HR AND HR.DATA_FIM_HR
   AND ORG.COD_EMP = 8
   --AND ORG.COD_TIPO = 1
   AND ORG.EDICAO_ORG_4 IS NOT NULL
   AND ORG.COD_UNIDADE NOT IN (014, 050, 615, 7586, 7608)
   --AND ORG.COD_UNIDADE = 004
 ORDER BY CT.COD_CONTRATO

),



STATUS_AFASTADOS AS (
SELECT DISTINCT
       ORG.COD_EMP,
       CT.COD_CONTRATO,
       ORG.COD_ORGANOGRAMA,
       ORG.COD_UNIDADE,
       NVL(AF.COD_CAUSA_AFAST,0) AS STATUS_AFAST,
       AF.DATA_INICIO AS DATA_INI_AFAST,
       AF.DATA_FIM AS DATA_FIM_AFAST
  FROM RHFP0306 AF,
       RHFP0300 CT,
       VH_EST_ORG_CONTRATO_AVT ORG,
       VH_CARGO_CONTRATO_AVT FN,
       PARAMETROS P
 WHERE CT.COD_CONTRATO = AF.COD_CONTRATO(+)
   AND CT.COD_CONTRATO = ORG.COD_CONTRATO(+)
   AND CT.COD_CONTRATO = FN.COD_CONTRATO(+)
   AND ((P.DATA_FIM BETWEEN CT.DATA_INICIO AND CT.DATA_FIM) OR
        (CT.DATA_INICIO <= P.DATA_FIM AND CT.DATA_FIM IS NULL))
   AND P.DATA_FIM BETWEEN AF.DATA_INICIO(+) AND AF.DATA_FIM(+)
   AND P.DATA_FIM BETWEEN ORG.DATA_INI_ORG(+) AND ORG.DATA_FIM_ORG(+)
   AND P.DATA_FIM BETWEEN FN.DATA_INI_CLH AND FN.DATA_FIM_CLH(+)
   AND ORG.COD_EMP = 8
   AND ORG.COD_UNIDADE NOT IN (014, 050, 615, 657, 7586, 7608)
   --AND ORG.COD_TIPO = 1
),




VLR_COM_APRENDIZ AS (
  SELECT
       E.EDICAO_NIVEL2 AS EDICAO_ORG_REP,
       E.EDICAO_NIVEL2,
       NV.NOME_ORGANOGRAMA,
       P.REFERENCIA,
       A.COD_VD,
       B.NOME_VD,
       SUM(NVL(A.VALOR_VD, 0)) AS TOTAL_COM_APRE,
       ROW_NUMBER() OVER(PARTITION BY E.EDICAO_NIVEL2 ORDER BY A.COD_VD) AS RN
    FROM PARAMETROS P
  JOIN RHFP1006 A ON 1=1
  JOIN RHFP1000 B ON A.COD_VD = B.COD_VD
  JOIN RHFP0310 D ON A.COD_CONTRATO = D.COD_CONTRATO
                 AND P.DATA_FIM BETWEEN D.DATA_INICIO AND D.DATA_FIM
  JOIN RHFP0401 E ON D.COD_ORGANOGRAMA = E.COD_ORGANOGRAMA
                 AND P.DATA_FIM BETWEEN E.DATA_INICIO AND E.DATA_FIM
  JOIN RHFP0400 F ON E.COD_ORGANOGRAMA = F.COD_ORGANOGRAMA
  LEFT JOIN V_ORGANOGRAMAS_NIVEIS NV ON E.EDICAO_NIVEL2 = NV.EDICAO_ORG
  WHERE COD_MESTRE_EVENTO IN (
          SELECT COD_MESTRE_EVENTO
            FROM RHFP1003
           WHERE DATA_REFERENCIA BETWEEN P.DATA_INICIO AND P.DATA_FIM
             AND COD_ORGANOGRAMA = :EMPRESA_8_1629_282
             AND COD_EVENTO IN (1,17,19,26)
        )
   AND NV.COD_NIVEL_ORG = 2
   AND NV.COD_ORGANOGRAMA NOT IN (293,301,302,304,305,309,313,315,316,318,320,322,326,327,328,329,330,331,335,349,399,939,1740,2147,2148,2149,2150,2151)
   AND NV.COD_ORGANOGRAMA_SUB NOT IN (344)
   AND A.COD_VD IN (2601, 2605, 2611, 2612, 2615, 2616, 2617, 2701, 2705, 2711, 2712, 2715, 2716, 2717)
   AND A.COD_VD NOT IN (292, 4033)
   AND A.VALOR_VD <> 0
 GROUP BY E.EDICAO_NIVEL2, NV.NOME_ORGANOGRAMA, A.COD_VD, B.NOME_VD, P.REFERENCIA

),



VLR_SO_APRENDIZ AS (
  SELECT
       E.EDICAO_NIVEL2 AS EDICAO_ORG_REP,
       E.EDICAO_NIVEL2,
       NV.NOME_ORGANOGRAMA,
       P.REFERENCIA,
       A.COD_VD,
       B.NOME_VD,
       SUM(NVL(A.VALOR_VD, 0)) AS TOTAL_APRE,
       ROW_NUMBER() OVER(PARTITION BY E.EDICAO_NIVEL2 ORDER BY A.COD_VD) AS RN
    FROM PARAMETROS P
  JOIN RHFP1006 A ON 1=1
  JOIN RHFP1000 B ON A.COD_VD = B.COD_VD
  JOIN RHFP0310 D ON A.COD_CONTRATO = D.COD_CONTRATO
                 AND P.DATA_FIM BETWEEN D.DATA_INICIO AND D.DATA_FIM
  JOIN RHFP0401 E ON D.COD_ORGANOGRAMA = E.COD_ORGANOGRAMA
                 AND P.DATA_FIM BETWEEN E.DATA_INICIO AND E.DATA_FIM
  JOIN RHFP0400 F ON E.COD_ORGANOGRAMA = F.COD_ORGANOGRAMA
  LEFT JOIN V_ORGANOGRAMAS_NIVEIS NV ON E.EDICAO_NIVEL2 = NV.EDICAO_ORG
  JOIN CONTRATOS CT ON A.COD_CONTRATO = CT.COD_CONTRATO
  WHERE COD_MESTRE_EVENTO IN (
          SELECT COD_MESTRE_EVENTO
            FROM RHFP1003
           WHERE DATA_REFERENCIA BETWEEN P.DATA_INICIO AND P.DATA_FIM
             AND COD_ORGANOGRAMA = :EMPRESA_8_1629_282
             AND COD_EVENTO IN (1,17,19,26)
        )
   AND NV.COD_NIVEL_ORG = 2
   AND NV.COD_ORGANOGRAMA NOT IN (293,301,302,304,305,309,313,315,316,318,320,322,326,327,328,329,330,331,335,349,399,939,1740,2147,2148,2149,2150,2151)
   AND NV.COD_ORGANOGRAMA_SUB NOT IN (344)
   AND A.COD_VD IN (2601, 2605, 2611, 2612, 2615, 2616, 2617, 2701, 2705, 2711, 2712, 2715, 2716, 2717)
   AND A.COD_VD NOT IN (292, 4033)
   AND A.VALOR_VD <> 0
   AND CT.DES_FUNCAO LIKE 'APRENDIZ%'
 GROUP BY E.EDICAO_NIVEL2, NV.NOME_ORGANOGRAMA, A.COD_VD, B.NOME_VD, P.REFERENCIA

),

VLR_SEM_APRENDIZ AS (
  SELECT
       E.EDICAO_NIVEL2 AS EDICAO_ORG_REP,
       E.EDICAO_NIVEL2,
       NV.NOME_ORGANOGRAMA,
       P.REFERENCIA,
       A.COD_VD,
       B.NOME_VD,
       SUM(NVL(A.VALOR_VD, 0)) AS TOTAL_SEM_APRE,
       ROW_NUMBER() OVER(PARTITION BY E.EDICAO_NIVEL2 ORDER BY A.COD_VD) AS RN
    FROM PARAMETROS P
  JOIN RHFP1006 A ON 1=1
  JOIN RHFP1000 B ON A.COD_VD = B.COD_VD
  JOIN RHFP0310 D ON A.COD_CONTRATO = D.COD_CONTRATO
                 AND P.DATA_FIM BETWEEN D.DATA_INICIO AND D.DATA_FIM
  JOIN RHFP0401 E ON D.COD_ORGANOGRAMA = E.COD_ORGANOGRAMA
                 AND P.DATA_FIM BETWEEN E.DATA_INICIO AND E.DATA_FIM
  JOIN RHFP0400 F ON E.COD_ORGANOGRAMA = F.COD_ORGANOGRAMA
  LEFT JOIN V_ORGANOGRAMAS_NIVEIS NV ON E.EDICAO_NIVEL2 = NV.EDICAO_ORG
  JOIN CONTRATOS CT ON A.COD_CONTRATO = CT.COD_CONTRATO
  WHERE COD_MESTRE_EVENTO IN (
          SELECT COD_MESTRE_EVENTO
            FROM RHFP1003
           WHERE DATA_REFERENCIA BETWEEN P.DATA_INICIO AND P.DATA_FIM
             AND COD_ORGANOGRAMA = :EMPRESA_8_1629_282
             AND COD_EVENTO IN (1,17,19,26)
        )
   AND NV.COD_NIVEL_ORG = 2
   AND NV.COD_ORGANOGRAMA NOT IN (293,301,302,304,305,309,313,315,316,318,320,322,326,327,328,329,330,331,335,349,399,939,1740,2147,2148,2149,2150,2151)
   AND NV.COD_ORGANOGRAMA_SUB NOT IN (344)
   AND A.COD_VD IN (2601, 2605, 2611, 2612, 2615, 2616, 2617, 2701, 2705, 2711, 2712, 2715, 2716, 2717)
   AND A.COD_VD NOT IN (292, 4033)
   AND A.VALOR_VD <> 0
   AND CT.DES_FUNCAO NOT LIKE 'APRENDIZ%'
 GROUP BY E.EDICAO_NIVEL2, NV.NOME_ORGANOGRAMA, A.COD_VD, B.NOME_VD, P.REFERENCIA

)

SELECT COALESCE(A.EDICAO_NIVEL2, B.EDICAO_NIVEL2, C.EDICAO_NIVEL2) AS EDICAO_NIVEL2,
       COALESCE(A.NOME_ORGANOGRAMA, B.NOME_ORGANOGRAMA, C.NOME_ORGANOGRAMA) AS NOME_ORGANOGRAMA,
       COALESCE(A.COD_VD, B.COD_VD, C.COD_VD) AS COD_VD,
       COALESCE(A.NOME_VD, B.NOME_VD, C.NOME_VD) AS NOME_VD,
       COALESCE(A.REFERENCIA, B.REFERENCIA, C.REFERENCIA) AS REFERENCIA,
       TO_CHAR(NVL(A.TOTAL_COM_APRE, 0), 'FM999G999G990D00') AS COM_APRENDIZ,
       TO_CHAR(NVL(C.TOTAL_SEM_APRE, 0), 'FM999G999G990D00') AS SEM_APRENDIZ,
       TO_CHAR(NVL(B.TOTAL_APRE, 0), 'FM999G999G990D00') AS SO_APRENDIZ
  FROM VLR_COM_APRENDIZ A
  FULL OUTER JOIN VLR_SO_APRENDIZ B ON B.EDICAO_NIVEL2 = A.EDICAO_NIVEL2
                                   AND B.COD_VD = A.COD_VD
  FULL OUTER JOIN VLR_SEM_APRENDIZ C ON C.EDICAO_NIVEL2 =
                                        COALESCE(A.EDICAO_NIVEL2,
                                                 B.EDICAO_NIVEL2)
                                    AND C.COD_VD =
                                        COALESCE(A.COD_VD, B.COD_VD)
 ORDER BY EDICAO_NIVEL2, COD_VD